\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{tikzviolinplots}[2021/08/20 Violin plot creation in pgfplots]

\RequirePackage{pgfplots}
\RequirePackage{pgfplotstable}
\RequirePackage{ifthen}


\DeclareOption*{\PackageWarning{tikzviolinplots}{Unknown option: ‘\CurrentOption’}}
\ProcessOptions\relax

\newcommand{\violinsetoptions}[3][]{%

	\providecommand{\violinscaled}{}
	\renewcommand{\violinscaled}{#1}
	\providecommand{\violinaxisoptions}{}
	\renewcommand{\violinaxisoptions}{#2}
	\providecommand{\violinotheroptions}{}
	\renewcommand{\violinotheroptions}{#3}

	\begin{axis}[
		\violinaxisoptions,
		\violinotheroptions,
		axis on top,
		xticklabels={,,},
		xmajorticks=false,
	]
	\end{axis}
}

\newcommand{\kde}[7][]{%

	% We start by making sure all commands are already existent.
	% This forces us to use \renewcommand instead of \newcommand,
	% but no errors occur due to using the command twice.

	\providecommand{\bandwith}{}
	\providecommand{\thefilename}{}
	\providecommand{\theindex}{}
	\providecommand{\nsamples}{}
	\providecommand{\thedelta}{}
	\providecommand{\thecolor}{}
	\providecommand{\thelabel}{}

	\renewcommand{\bandwith}{#1}
	\renewcommand{\thefilename}{#2}
	\renewcommand{\theindex}{#3}
	\renewcommand{\nsamples}{#4}
	\renewcommand{\thedelta}{#5}
	\renewcommand{\thecolor}{#6}
	\renewcommand{\thelabel}{#7}

	\pgfplotstableread{\thefilename}\theoldtable

	\pgfplotstablegetrowsof{\theoldtable}
	\providecommand{\pgfcolsize}{}
	\pgfmathparse{int(\pgfmathresult-1)}
	\let\pgfcolsize\pgfmathresult

	\pgfmathparse{0}
	\let\kdestddev\pgfmathresult
	\let\kdeaverage\pgfmathresult

	\pgfplotstableforeachcolumnelement{\theindex}\of\theoldtable\as\xi{%
		\pgfmathparse{\kdeaverage+(\xi/(1+\pgfcolsize))}
		\let\kdeaverage\pgfmathresult
	}

	\ifthenelse{%
		\equal{\bandwith}{}%
	}{%
		\pgfplotstableforeachcolumnelement{\theindex}\of\theoldtable\as\xi{%
			\pgfmathparse{\kdestddev+(\xi-\kdeaverage)^2}
			\let\kdestddev\pgfmathresult
		}
		\pgfmathparse{sqrt(\kdestddev/(1+\pgfcolsize))}
		\let\kdestddev\pgfmathresult
		\pgfmathparse{1.06*\kdestddev*((1+\pgfcolsize)^0.2)}%
		\let\bandwith\pgfmathresult
	}{%
	}

	\pgfplotstablegetelem{0}{\theindex}\of{\theoldtable}
	\providecommand{\smallestelem}{}
	\renewcommand{\smallestelem}{\pgfplotsretval}
	\providecommand{\biggestelem}{}
	\renewcommand{\biggestelem}{\pgfplotsretval}
	\pgfplotstableforeachcolumnelement{\theindex}\of\theoldtable\as\xi{%
		\pgfmathparse{%
			\xi > \smallestelem ? int(0) : int(1)%
		}
		\ifthenelse{
			\pgfmathresult = 1
		}{
			\let\smallestelem\xi
		}{
		}
	}
	\pgfmathparse{\smallestelem - 3*\bandwith}
	\let\smallestelem\pgfmathresult

	\pgfplotstableforeachcolumnelement{\theindex}\of\theoldtable\as\xi{%
		\pgfmathparse{%
			\xi < \biggestelem ? int(0) : int(1)%
		}
		\ifthenelse{
			\pgfmathresult = 1
		}{
			\let\biggestelem\xi
		}{
		}
	}
	\pgfmathparse{\biggestelem + 3*\bandwith}
	\let\biggestelem\pgfmathresult

	\pgfplotstableset{
		create on use/list/.style={create col/expr={
			\smallestelem + (\biggestelem-\smallestelem)
			*(\pgfplotstablerow/(\nsamples-1))
		}}
	}


	\pgfplotstablenew[columns={list}]{\nsamples}\thetable

	\pgfmathparse{0.0}
	\let\biggesteleminkde\pgfmathresult

	\pgfplotstablecreatecol[
		create col/assign/.code={
			\pgfmathparse{\pgfcolsize+1}
			\let\pgfcolsize\pgfmathresult
			\pgfmathparse{%
				1.0/(\pgfcolsize*\bandwith*sqrt(2*3.14159265))
			}
			\let\multiplier\pgfmathresult
			\pgfmathparse{0}
			\let\accumkde\pgfmathresult
			\pgfplotstableforeachcolumnelement{\theindex}\of\theoldtable\as\xi{%
				\pgfmathparse{((\xi-\thisrow{list})/\bandwith)}
				\let\exparg\pgfmathresult
				\pgfmathparse{\accumkde + e^(-0.5*\exparg*\exparg)}
				\let\accumkde\pgfmathresult
			}
			\pgfmathparse{\accumkde*\multiplier}
			\let\entry\pgfmathresult
			\pgfkeyslet{/pgfplots/table/create col/next content}\entry
		}
	]{kdecol}\thetable

	\pgfplotstableforeachcolumnelement{kdecol}\of\thetable\as\entry{%
		\pgfmathparse{%
			\entry < \biggesteleminkde ? int(0) : int(1)%
		}
		\ifthenelse{
			\pgfmathresult = 1
		}{
			\let\biggesteleminkde\entry
		}{
		}
	}

	\pgfplotstablemodifyeachcolumnelement{kdecol}\of\thetable\as\cell{%
		\let\pgfplotstablezero\thedelta
		\ifthenelse{
			\pgfplotstablerow = 0
		}{
			\let\cell\pgfplotstablezero
		}{
			\pgfmathparse{int(\nsamples-1)}
			\ifthenelse{
				\pgfplotstablerow = \pgfmathresult
			}{
				\let\cell\pgfplotstablezero
			}{
				\ifthenelse{
					\equal{\violinscaled}{}
				}{
					\pgfmathparse{\thedelta+\cell}
				}{
					\pgfmathparse{\thedelta+0.5*\cell/\biggesteleminkde}
				}
				\let\cell\pgfmathresult
			}
		}
	}

	\pgfplotstablecreatecol[
		create col/assign/.code={
			\pgfmathparse{-\thisrow{kdecol}+2*\thedelta}
			\let\entry\pgfmathresult
			\pgfkeyslet{/pgfplots/table/create col/next content}\entry
		}
	]{kdecolinv}\thetable

	\begin{axis}[
		\violinaxisoptions,
		axis on top,
		yticklabels={,,},%
		xticklabels={\thelabel},
		xtick={\thedelta},
	]
		\addplot[
			no marks,
			color=\thecolor,
		] table [
			x index=1, y index=0
		] {\thetable};
		\addplot[
			no marks,
			fill=\thecolor,
			opacity=0.50,
		] table [
			x index=1, y index=0
		] {\thetable};
		\addplot[
			no marks,
			color=\thecolor,
		] table [
			x index=2, y index=0
		] {\thetable};
		\addplot[
			no marks,
			fill=\thecolor,
			opacity=0.50,
		] table [
			x index=2, y index=0
		] {\thetable};
		\addplot[
			no marks,
			color=black,
		] coordinates {
			(\thedelta,\pgfkeysvalueof{/pgfplots/ymin})%
			(\thedelta,\pgfkeysvalueof{/pgfplots/ymax})
		};
		\addplot[
			only marks,
			mark=o,
			color=black,
		] coordinates {
			(\thedelta,\kdeaverage)
		};
	\end{axis}

}
